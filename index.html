<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8" />
    <title>Mortgage Calculator</title>
    <script src="https://unpkg.com/react@latest/dist/react.js"></script>
    <script src="https://unpkg.com/react-dom@latest/dist/react-dom.js"></script>
    <script src="https://unpkg.com/babel-standalone@6.15.0/babel.min.js"></script>

    <link href="https://cdnjs.cloudflare.com/ajax/libs/c3/0.4.15/c3.min.css" rel="stylesheet"></link>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.17/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/c3/0.4.15/c3.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.4/lodash.min.js"></script>
    <style>
        * {
            /* outline: 1px solid black; */
            margin: 0;
            padding: 0;
        }

        html {
            min-height: 100%;
        }

        body {
            font-size: 18px;
            font-family: 'Helvetica', sans-serif;
            height: 100%;
            display: flex;
            justify-content: center;
        }

        #root {
            font-size: 1em;
            background: lightgray;
            color: darkslategrey;
            width: 100%;
            display: flex;
            justify-content: center;
            min-height: 100%;
            height: 100%;
        }
    </style>
</head>

<body>
    <div id="root"></div>
    <script type="text/babel">
        var container = document.getElementById('root');

        class InputContainer extends React.Component {
            constructor(props) {
                super(props);
                this.handleChange = this.handleChange.bind(this);
            }

            handleChange(e) {
                this.props.onChange(e.target.value);
            }

            render() {
                const { val, min, max } = this.props;

                const styles = {
                    containerStyle: {
                        display: 'flex',
                        flexDirection: 'column',
                    },
                    textLineStyle: {
                        display: 'flex',
                        flexDirectin: 'row'
                    },
                    labelStyle: {
                        width: 200
                    },
                }

                return (
                    <div style={styles.containerStyle}>
                        <div style={styles.textLineStyle}>
                            <div style={styles.labelStyle}>{this.props.children}:</div>
                            <input type='number' value={val} onChange={this.handleChange} />
                        </div>
                        <input type='range' min={min} max={max} value={val} onChange={this.handleChange} />
                    </div>
                )
            }
        }

        class InputSection extends React.Component {
                render() {
                const styles = {
                    display: 'flex',
                    flexDirection: 'column',
                    borderBottomColor: 'darkslategray',
                    borderBottomStyle: 'solid',
                    borderBottomWidth: 1,
                    paddingTop: 10,
                    paddingBottom: 10,
                };

                return (
                    <div style={styles}>{this.props.children}</div>
                )
            }
        }

        class Header extends React.Component {
            render() {
                const styles = {
                    containerStyle: {
                        display: 'flex',
                        flexDirection: 'row',
                        justifyContent: 'center',
                        padding: 10
                    },
                    headerStyle: {
                        fontSize: 32,
                        color: 'black',
                    },
                };
                
                return (
                    <div style={styles.containerStyle}>
                        <div style={styles.headerStyle}>{this.props.children}</div>
                    </div>
                )
            }
        }

        class OutputContainer extends React.Component {
            render() {
                const val = this.props.val.toFixed(2);

                const styles = {
                    lineStyle: {
                        display: 'flex',
                        flexDirectin: 'row',
                        height: '2em',
                        lineHeight: '2em'
                    },
                    labelStyle: {
                        width: 200
                    },
                    valueStyle: {
                        textAlign: 'right',
                        flexGrow: 1
                    }
                }

                return (
                    <div style={styles.lineStyle}>
                        <div style={styles.labelStyle}>{this.props.children}:</div>
                        <div style={styles.valueStyle}>${val}</div>
                    </div>
                )
            }
        }

        class App extends React.Component {
            constructor(props) {
                super(props);

                this.debounce = _.debounce(this.recalculate, 100);                
            }
            
            componentDidMount() {
                this.chart = c3.generate({
                    bindto: '#chart',
                    data: {
                        columns: [
                            ['balance'],
                        ]
                    }
                });
                this.recalculate();
            }

            componentWillMount() {
                this.state = {
                    salePrice: 180000,
                    insurance: 100,
                    pmi: 118,
                    term: 360,
                    taxes: 3500,
                    monthlyTax: 3500/12,
                    downPaymentPercent: 3.5,
                    apr: 4,
                    payment: 0,
                    totalInterest: 0,
                    calculateRan: false,
                    downPayment: 0,
                    amountToFinance: 0,
                }
                this.updateDownPayment();
            }

            updateDownPayment() {
                this.setState({downPayment: this.state.downPaymentPercent * this.state.salePrice / 100});
                this.updateAmountToFinance();
            }

            updateAmountToFinance() {
                this.setState({amountToFinance: this.state.salePrice - this.state.downPayment});
            }

            recalculate() {
                console.log('Recalculating.');
                var pmt = this.calculate();
                this.setState({payment: pmt, calculateRan: true});
            }

            calculate() {
                var origBal = this.state.amountToFinance;
                var bal = origBal;
                var payment = 0;
                var monthlyRate = this.state.apr/1200;
                var bals = [bal];
                var ints = [0];
                var totalInt = 0;

                while (payment < bal) {
                    for (var i = 0; i < this.state.term; i++) {
                        var interest = monthlyRate * bal;
                        totalInt += interest;
                        ints.push(totalInt);

                        var principle = payment - interest;
                        bal = bal - principle;
                        bals.push(bal)
                    }

                    if (bal <= 0) {
                        this.chart.load({
                            columns: [
                                ['balance', ...bals],
                                ['interest', ...ints],
                            ]
                        })
                        this.setState({totalInterest: totalInt});
                        return payment;
                    }

                    payment += 0.01;
                    bal = origBal;
                    bals = [bal];
                    ints = [];
                    totalInt = 0;
                }

                this.chart.load({
                    columns: [
                        ['balance', ...bals],
                        ['interest', ...ints],                        
                    ]
                })
                return payment;
            }

            onPriceChange(val) {
                this.updateDownPayment();
                this.debounce();
                this.setState({salePrice: val});
            }

            onInsuranceChange(val) {
                this.setState({insurance: val});
            }

            onPMIChange(val) {
                this.setState({pmi: val});
            }

            onTermChange(val) {
                this.debounce();
                this.setState({term: val});
            }

            onTaxChange(val) {
                this.setState({taxes: val, monthlyTax: val/12});
            }

            onDownPaymentChange(val) {
                this.updateDownPayment();
                this.debounce();
                this.setState({downPaymentPercent: val});
            }

            onAPRChange(val) {
                this.debounce();
                this.setState({apr: val});
            }

            totalPayment() {
                return parseFloat(this.state.payment)+
                    parseFloat(this.state.pmi)+
                    (parseFloat(this.state.taxes)/12)+
                    parseFloat(this.state.insurance);
            }

            render() {
                const styles = {
                    hideGraph: {
                        display: 'none',
                    },
                    outputSectionStyle: {
                        display: 'flex',
                        flexDirection: 'column',
                        borderBottomColor: 'darkslategray',
                        borderBottomStyle: 'solid',
                        borderBottomWidth: 1,
                        paddingTop: 10,
                        paddingBottom: 10,
                    },
                    taxNoticeStyle: {
                        fontSize: 10,
                    },
                };

                return (
                    <div>
                        <Header>Mortgage Calculator</Header>

                        <InputSection>
                            <InputContainer 
                                min='0' max='300000' 
                                val={this.state.salePrice} onChange={this.onPriceChange.bind(this)}>
                                Sale Price
                            </InputContainer>
                            <InputContainer 
                                min='0' max='20' 
                                val={this.state.downPaymentPercent} onChange={this.onDownPaymentChange.bind(this)}>
                                Down Payment
                            </InputContainer>
                            { /* TODO: add step */ }
                            <InputContainer 
                                min='0' max='7' 
                                val={this.state.apr} onChange={this.onAPRChange.bind(this)}>
                                APR
                            </InputContainer>
                            <InputContainer 
                                min='0' max='360' 
                                val={this.state.term} onChange={this.onTermChange.bind(this)}>
                                Term
                            </InputContainer>
                        </InputSection>

                        <InputSection>
                            <InputContainer 
                                min='0' max='300' 
                                val={this.state.pmi} onChange={this.onPMIChange.bind(this)}>
                                PMI
                            </InputContainer>
                            <InputContainer 
                                min='0' max='10000' 
                                val={this.state.taxes} onChange={this.onTaxChange.bind(this)}>
                                Taxes
                            </InputContainer>
                            <InputContainer 
                                min='0' max='200' 
                                val={this.state.insurance} onChange={this.onInsuranceChange.bind(this)}>
                                Insurance
                            </InputContainer>
                        </InputSection>

                        <div style={styles.outputSectionStyle}>
                            <OutputContainer val={this.state.downPayment}>Down Payment</OutputContainer>
                            <OutputContainer val={this.state.amountToFinance}>Amount To Finance</OutputContainer>
                            <OutputContainer val={this.state.payment}>Payment Amount</OutputContainer>
                            <OutputContainer val={this.state.totalInterest}>Total Interest</OutputContainer>
                            <OutputContainer val={this.state.totalInterest+this.state.amountToFinance}>Total Of Payments</OutputContainer>
                            <OutputContainer val={this.totalPayment()}>Total Monthly Payment</OutputContainer>
                            <div style={styles.taxNoticeStyle}>
                                <em>Includes ${this.state.monthlyTax.toFixed(2)} for taxes.</em>
                            </div>
                        </div>
                        
                        <div id="chart" style={(!this.state.calculateRan) ? styles.hideGraph : {}}></div>
                    </div>
                )
            }
        }

        ReactDOM.render(<App />, container);
    </script>
</body>

</html>